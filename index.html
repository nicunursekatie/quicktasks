<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #515154;
            --text-muted: #86868b;
            --border-color: #e5e5e7;
            --accent-today: #ff3b30;
            --accent-longterm: #5856d6;
            --accent-success: #34c759;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.16);
            --gradient-premium: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #f5f5f7;
            --text-secondary: #b0b0b0;
            --text-muted: #6e6e73;
            --border-color: #3a3a3a;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            padding: 20px;
            line-height: 1.6;
            transition: background 0.3s ease;
            min-height: 100vh;
        }

        .top-bar {
            max-width: 900px;
            margin: 0 auto 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            background: var(--gradient-premium);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
            font-size: 18px;
        }

        .icon-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            color: var(--text-primary);
        }

        .icon-btn:active {
            transform: translateY(0);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .date-stamp {
            text-align: center;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 24px;
            letter-spacing: 0.5px;
        }

        .section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-premium);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .section:hover::before {
            opacity: 1;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .section-title-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .badge {
            font-size: 11px;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 8px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .badge-today {
            background: var(--accent-today);
            color: white;
        }

        .badge-longterm {
            background: var(--accent-longterm);
            color: white;
        }

        .progress-ring {
            width: 40px;
            height: 40px;
            position: relative;
        }

        .progress-circle {
            transform: rotate(-90deg);
        }

        .progress-circle-bg {
            fill: none;
            stroke: var(--border-color);
            stroke-width: 3;
        }

        .progress-circle-fill {
            fill: none;
            stroke: var(--accent-success);
            stroke-width: 3;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            font-weight: 700;
            color: var(--text-secondary);
        }

        h1 {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-primary);
        }

        h2 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-group {
            margin-bottom: 28px;
            padding: 16px;
            background: var(--bg-primary);
            border-radius: 12px;
        }

        .task-group:last-child {
            margin-bottom: 0;
        }

        .task-item {
            display: flex;
            gap: 12px;
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            cursor: pointer;
        }

        .task-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
            border-color: var(--text-muted);
        }

        .task-item.checked {
            opacity: 0.6;
        }

        .checkbox-wrapper {
            position: relative;
            flex-shrink: 0;
        }

        .task-item input[type="checkbox"] {
            appearance: none;
            width: 22px;
            height: 22px;
            border: 2px solid var(--text-muted);
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            background: var(--bg-secondary);
        }

        .task-item input[type="checkbox"]:hover {
            border-color: var(--accent-success);
            transform: scale(1.1);
        }

        .task-item input[type="checkbox"]:checked {
            background: var(--accent-success);
            border-color: var(--accent-success);
        }

        .task-item input[type="checkbox"]:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 15px;
        }

        .task-item.checked .task-title {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .subtasks {
            margin-top: 12px;
            padding-left: 16px;
            border-left: 2px solid var(--border-color);
        }

        .subtask {
            display: flex;
            gap: 8px;
            padding: 8px 0;
            font-size: 14px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .subtask:hover {
            color: var(--text-primary);
        }

        .subtask input[type="checkbox"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--text-muted);
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 2px;
            transition: all 0.2s ease;
            background: var(--bg-secondary);
        }

        .subtask input[type="checkbox"]:checked {
            background: var(--accent-success);
            border-color: var(--accent-success);
        }

        .subtask input[type="checkbox"]:checked::after {
            content: '‚úì';
            position: absolute;
            color: white;
            font-size: 12px;
            font-weight: bold;
            margin-left: -15px;
            margin-top: -2px;
        }

        .subtask.checked {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .quick-add {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }

        .quick-add input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .quick-add input:focus {
            outline: none;
            border-color: var(--accent-success);
            box-shadow: 0 0 0 3px rgba(52, 199, 89, 0.1);
        }

        .quick-add button {
            padding: 12px 24px;
            background: var(--gradient-premium);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .quick-add button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .quick-add button:active {
            transform: translateY(0);
        }

        .stats-panel, .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--bg-secondary);
            box-shadow: var(--shadow-lg);
            padding: 32px;
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .stats-panel.open, .settings-panel.open {
            right: 0;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .panel-header h2 {
            font-size: 22px;
            margin-bottom: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .stat-card {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            background: var(--border-color);
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: var(--accent-success);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active::after {
            left: 25px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 999;
        }

        .overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .task-item, .task-group {
            animation: slideIn 0.3s ease;
        }

        @media (max-width: 600px) {
            body {
                padding: 12px;
            }

            .section {
                padding: 20px;
            }

            .stats-panel, .settings-panel {
                width: 100%;
                right: -100%;
            }

            h1 {
                font-size: 22px;
            }

            h2 {
                font-size: 15px;
            }

            .logo {
                font-size: 20px;
            }
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .delete-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 16px;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .task-item:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            background: #ff3b30;
            color: white;
        }

        .group-progress {
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .group-progress-fill {
            height: 100%;
            background: var(--gradient-premium);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>

    <div class="top-bar">
        <div class="logo">‚úì QuickTasks</div>
        <div class="controls">
            <div id="syncStatus" style="font-size: 12px; color: var(--text-muted); margin-right: 8px; display: none;">
                <span id="syncIcon">‚òÅÔ∏è</span> <span id="syncText">Synced</span>
            </div>
            <button class="icon-btn" id="authBtn" onclick="handleAuth()" title="Sign In" style="display: none;">
                üë§
            </button>
            <button class="icon-btn" onclick="toggleStats()" title="Statistics">üìä</button>
            <button class="icon-btn" onclick="toggleSettings()" title="Settings">‚öôÔ∏è</button>
            <button class="icon-btn" onclick="toggleTheme()" title="Toggle Theme">üåô</button>
        </div>
    </div>

    <div class="container">
        <div class="date-stamp" id="dateStamp"></div>

        <!-- TODAY SECTION -->
        <div class="section" id="todaySection">
            <div class="section-header">
                <div class="section-title-group">
                    <span class="badge badge-today">Today</span>
                    <h1>Today</h1>
                </div>
                <div class="progress-ring" id="todayProgress">
                    <svg width="40" height="40" class="progress-circle">
                        <circle class="progress-circle-bg" cx="20" cy="20" r="16"></circle>
                        <circle class="progress-circle-fill" cx="20" cy="20" r="16"
                                stroke-dasharray="100.48" stroke-dashoffset="100.48"></circle>
                    </svg>
                    <div class="progress-text">0%</div>
                </div>
            </div>

            <div id="todayTasks">
                <!-- Tasks will be rendered here -->
            </div>

            <div class="quick-add">
                <input type="text" id="quickAddToday" placeholder="Quick add task (press Enter)"
                       onkeypress="handleQuickAdd(event, 'today')">
                <button onclick="addQuickTask('today')">+ Add</button>
            </div>
        </div>

        <!-- LONG-TERM SECTION -->
        <div class="section" id="longtermSection">
            <div class="section-header">
                <div class="section-title-group">
                    <span class="badge badge-longterm">Long-term</span>
                    <h1>Ongoing Projects</h1>
                </div>
                <div class="progress-ring" id="longtermProgress">
                    <svg width="40" height="40" class="progress-circle">
                        <circle class="progress-circle-bg" cx="20" cy="20" r="16"></circle>
                        <circle class="progress-circle-fill" cx="20" cy="20" r="16"
                                stroke-dasharray="100.48" stroke-dashoffset="100.48"></circle>
                    </svg>
                    <div class="progress-text">0%</div>
                </div>
            </div>

            <div id="longtermTasks">
                <!-- Tasks will be rendered here -->
            </div>

            <div class="quick-add">
                <input type="text" id="quickAddLongterm" placeholder="Quick add project (press Enter)"
                       onkeypress="handleQuickAdd(event, 'longterm')">
                <button onclick="addQuickTask('longterm')">+ Add</button>
            </div>
        </div>
    </div>

    <!-- Stats Panel -->
    <div class="stats-panel" id="statsPanel">
        <div class="panel-header">
            <h2>üìä Statistics</h2>
            <button class="close-btn" onclick="toggleStats()">√ó</button>
        </div>

        <div class="stat-card">
            <div class="stat-label">Completed Today</div>
            <div class="stat-value" id="statCompletedToday">0</div>
        </div>

        <div class="stat-card">
            <div class="stat-label">Total Tasks</div>
            <div class="stat-value" id="statTotalTasks">0</div>
        </div>

        <div class="stat-card">
            <div class="stat-label">Completion Rate</div>
            <div class="stat-value" id="statCompletionRate">0%</div>
        </div>

        <div class="stat-card">
            <div class="stat-label">Active Projects</div>
            <div class="stat-value" id="statActiveProjects">0</div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="panel-header">
            <h2>‚öôÔ∏è Settings</h2>
            <button class="close-btn" onclick="toggleSettings()">√ó</button>
        </div>

        <div class="setting-item">
            <div class="setting-label">Dark Mode</div>
            <div class="toggle-switch" id="darkModeToggle" onclick="toggleTheme()"></div>
        </div>

        <div class="setting-item">
            <div class="setting-label">Show Completed</div>
            <div class="toggle-switch active" id="showCompletedToggle" onclick="toggleShowCompleted()"></div>
        </div>

        <div class="setting-item">
            <div class="setting-label">Auto-save</div>
            <div class="toggle-switch active"></div>
        </div>

        <div class="setting-item" style="border: none; padding-top: 24px;">
            <button style="width: 100%; padding: 12px; background: var(--accent-today); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;" onclick="clearAllData()">
                Clear All Data
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration - REPLACE WITH YOUR OWN CONFIG
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        let app, auth, db;
        let currentUser = null;
        let syncEnabled = false;

        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            syncEnabled = true;
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.warn('Firebase initialization failed, using local storage only:', error);
            syncEnabled = false;
        }

        // Initial task data
        const initialData = {
            today: [
                {
                    groupName: "Giving Tuesday",
                    tasks: [
                        { title: "Pull list of everyone who got the first GT email", completed: false },
                        { title: "Identify who has already donated", completed: false },
                        { title: "Remove donors from the next send", completed: false },
                        { title: "Finalize content for the second GT email", completed: false }
                    ]
                },
                {
                    groupName: "Steve's PowerPoint",
                    tasks: [
                        { title: "Open Alloy", completed: false },
                        { title: "Work on Steve's PowerPoint deck in Alloy", completed: false }
                    ]
                }
            ],
            longterm: [
                {
                    groupName: "Strategic Comms Shift",
                    tasks: [
                        { title: "Move non-urgent comms and random ideas from group texts ‚Üí app", completed: false },
                        { title: "Build UI for idea submission so nothing gets lost", completed: false }
                    ]
                },
                {
                    groupName: "Volunteer Speakers",
                    tasks: [
                        { title: "Onboard volunteer speakers into the app", completed: false },
                        { title: "Clean event-signup UI so they can see and self-select upcoming events", completed: false }
                    ]
                },
                {
                    groupName: "Drivers",
                    tasks: [
                        {
                            title: "Long-term: drivers should browse events, self-sign up, and get notifications",
                            completed: false,
                            subtasks: [
                                { title: "Requires accurate driver location data in the database", completed: false }
                            ]
                        }
                    ]
                },
                {
                    groupName: "Jordan Clarification",
                    tasks: [
                        {
                            title: "Have the 5-minute convo about driver list updates",
                            completed: false,
                            subtasks: [
                                { title: "Clarify: update driver list not for agreements, but to fill in driver locations to power app tools", completed: false }
                            ]
                        }
                    ]
                },
                {
                    groupName: "Alloy Folder",
                    tasks: [
                        { title: "Review the Alloy folder for materials relevant to Steve's deck", completed: false }
                    ]
                },
                {
                    groupName: "Mobile + Urgent Comms Problem",
                    tasks: [
                        {
                            title: "Long-term plan to onboard users with SMS consent for urgent items",
                            completed: false,
                            subtasks: [
                                { title: "Build targeted text system for urgent comms", completed: false },
                                { title: "Possibly build separate mobile-optimized version or separate mobile app", completed: false }
                            ]
                        }
                    ]
                }
            ]
        };

        // Load data from localStorage or use initial data
        let taskData = JSON.parse(localStorage.getItem('taskData')) || initialData;
        let settings = JSON.parse(localStorage.getItem('settings')) || {
            darkMode: false,
            showCompleted: true
        };

        // Initialize
        function init() {
            updateDateStamp();
            applyTheme();
            renderTasks();
            updateStats();
            updateProgress();

            // Set up auth state listener
            if (syncEnabled) {
                auth.onAuthStateChanged(handleAuthStateChange);
                document.getElementById('authBtn').style.display = 'flex';
                document.getElementById('syncStatus').style.display = 'flex';
            }
        }

        // Handle auth state changes
        function handleAuthStateChange(user) {
            currentUser = user;

            if (user) {
                console.log('User signed in:', user.email);
                document.getElementById('authBtn').title = 'Sign Out (' + user.email + ')';
                updateSyncStatus('Syncing...', 'üîÑ');
                loadFromFirestore();
            } else {
                console.log('User signed out');
                document.getElementById('authBtn').title = 'Sign In';
                updateSyncStatus('Not synced', '‚òÅÔ∏è');
            }
        }

        // Handle authentication
        async function handleAuth() {
            if (currentUser) {
                // Sign out
                if (confirm('Sign out?')) {
                    await auth.signOut();
                }
            } else {
                // Sign in with Google
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await auth.signInWithPopup(provider);
                } catch (error) {
                    console.error('Authentication error:', error);
                    alert('Authentication failed: ' + error.message);
                }
            }
        }

        // Update sync status
        function updateSyncStatus(text, icon) {
            document.getElementById('syncText').textContent = text;
            document.getElementById('syncIcon').textContent = icon;
        }

        // Load data from Firestore
        async function loadFromFirestore() {
            if (!syncEnabled || !currentUser) return;

            try {
                const docRef = db.collection('users').doc(currentUser.uid);
                const doc = await docRef.get();

                if (doc.exists) {
                    const data = doc.data();
                    taskData = data.taskData || initialData;
                    settings = data.settings || { darkMode: false, showCompleted: true };

                    // Update UI
                    applyTheme();
                    renderTasks();
                    updateStats();
                    updateProgress();

                    // Set up real-time listener
                    setupRealtimeSync();

                    updateSyncStatus('Synced', '‚úì');
                } else {
                    // First time user, save initial data
                    await saveToFirestore();
                    setupRealtimeSync();
                }
            } catch (error) {
                console.error('Error loading from Firestore:', error);
                updateSyncStatus('Sync failed', '‚ö†Ô∏è');
            }
        }

        // Save data to Firestore
        async function saveToFirestore() {
            if (!syncEnabled || !currentUser) return;

            try {
                updateSyncStatus('Syncing...', 'üîÑ');

                await db.collection('users').doc(currentUser.uid).set({
                    taskData: taskData,
                    settings: settings,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                updateSyncStatus('Synced', '‚úì');
            } catch (error) {
                console.error('Error saving to Firestore:', error);
                updateSyncStatus('Sync failed', '‚ö†Ô∏è');
            }
        }

        // Set up real-time sync
        let unsubscribe = null;
        function setupRealtimeSync() {
            if (unsubscribe) unsubscribe();

            const docRef = db.collection('users').doc(currentUser.uid);
            unsubscribe = docRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();

                    // Only update if data has changed (to avoid loops)
                    const newData = JSON.stringify(data.taskData);
                    const currentData = JSON.stringify(taskData);

                    if (newData !== currentData) {
                        taskData = data.taskData || initialData;
                        settings = data.settings || settings;

                        applyTheme();
                        renderTasks();
                        updateStats();
                        updateProgress();

                        updateSyncStatus('Synced', '‚úì');
                    }
                }
            }, (error) => {
                console.error('Real-time sync error:', error);
                updateSyncStatus('Sync failed', '‚ö†Ô∏è');
            });
        }

        // Update date stamp
        function updateDateStamp() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const date = new Date().toLocaleDateString('en-US', options);
            document.getElementById('dateStamp').textContent = date;
        }

        // Render all tasks
        function renderTasks() {
            renderSection('today', 'todayTasks');
            renderSection('longterm', 'longtermTasks');
        }

        // Render a section
        function renderSection(section, containerId) {
            const container = document.getElementById(containerId);
            const groups = taskData[section];

            if (!groups || groups.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ú®</div>
                        <div>No tasks yet. Add one to get started!</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = groups.map((group, groupIndex) => {
                const totalTasks = group.tasks.length;
                const completedTasks = group.tasks.filter(t => t.completed).length;
                const progress = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;

                return `
                    <div class="task-group">
                        <h2>
                            ${group.groupName}
                            <span style="font-size: 12px; color: var(--text-muted); font-weight: 400;">
                                (${completedTasks}/${totalTasks})
                            </span>
                        </h2>
                        <div class="group-progress">
                            <div class="group-progress-fill" style="width: ${progress}%"></div>
                        </div>
                        ${group.tasks.map((task, taskIndex) => renderTask(section, groupIndex, taskIndex, task)).join('')}
                    </div>
                `;
            }).join('');
        }

        // Render a single task
        function renderTask(section, groupIndex, taskIndex, task) {
            if (!settings.showCompleted && task.completed) return '';

            return `
                <div class="task-item ${task.completed ? 'checked' : ''}" onclick="event.stopPropagation()">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" ${task.completed ? 'checked' : ''}
                               onchange="toggleTask('${section}', ${groupIndex}, ${taskIndex})">
                    </div>
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        ${task.subtasks ? `
                            <div class="subtasks">
                                ${task.subtasks.map((subtask, subIndex) => `
                                    <div class="subtask ${subtask.completed ? 'checked' : ''}">
                                        <input type="checkbox" ${subtask.completed ? 'checked' : ''}
                                               onchange="toggleSubtask('${section}', ${groupIndex}, ${taskIndex}, ${subIndex})">
                                        <span>${subtask.title}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <button class="delete-btn" onclick="deleteTask('${section}', ${groupIndex}, ${taskIndex})">üóëÔ∏è</button>
                </div>
            `;
        }

        // Toggle task completion
        function toggleTask(section, groupIndex, taskIndex) {
            taskData[section][groupIndex].tasks[taskIndex].completed =
                !taskData[section][groupIndex].tasks[taskIndex].completed;
            saveData();
            renderTasks();
            updateStats();
            updateProgress();
        }

        // Toggle subtask completion
        function toggleSubtask(section, groupIndex, taskIndex, subIndex) {
            taskData[section][groupIndex].tasks[taskIndex].subtasks[subIndex].completed =
                !taskData[section][groupIndex].tasks[taskIndex].subtasks[subIndex].completed;
            saveData();
            renderTasks();
            updateStats();
        }

        // Delete task
        function deleteTask(section, groupIndex, taskIndex) {
            if (confirm('Delete this task?')) {
                taskData[section][groupIndex].tasks.splice(taskIndex, 1);
                if (taskData[section][groupIndex].tasks.length === 0) {
                    taskData[section].splice(groupIndex, 1);
                }
                saveData();
                renderTasks();
                updateStats();
                updateProgress();
            }
        }

        // Quick add task
        function handleQuickAdd(event, section) {
            if (event.key === 'Enter') {
                addQuickTask(section);
            }
        }

        function addQuickTask(section) {
            const inputId = section === 'today' ? 'quickAddToday' : 'quickAddLongterm';
            const input = document.getElementById(inputId);
            const title = input.value.trim();

            if (!title) return;

            // Add to "Quick Tasks" group or create it
            let quickGroup = taskData[section].find(g => g.groupName === 'Quick Tasks');
            if (!quickGroup) {
                quickGroup = { groupName: 'Quick Tasks', tasks: [] };
                taskData[section].unshift(quickGroup);
            }

            quickGroup.tasks.push({ title, completed: false });
            input.value = '';

            saveData();
            renderTasks();
            updateStats();
            updateProgress();
        }

        // Update statistics
        function updateStats() {
            let totalTasks = 0;
            let completedTasks = 0;
            let completedToday = 0;

            ['today', 'longterm'].forEach(section => {
                taskData[section].forEach(group => {
                    group.tasks.forEach(task => {
                        totalTasks++;
                        if (task.completed) {
                            completedTasks++;
                            if (section === 'today') completedToday++;
                        }
                    });
                });
            });

            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            document.getElementById('statCompletedToday').textContent = completedToday;
            document.getElementById('statTotalTasks').textContent = totalTasks;
            document.getElementById('statCompletionRate').textContent = completionRate + '%';
            document.getElementById('statActiveProjects').textContent = taskData.longterm.length;
        }

        // Update progress rings
        function updateProgress() {
            updateSectionProgress('today', 'todayProgress');
            updateSectionProgress('longterm', 'longtermProgress');
        }

        function updateSectionProgress(section, progressId) {
            let total = 0;
            let completed = 0;

            taskData[section].forEach(group => {
                group.tasks.forEach(task => {
                    total++;
                    if (task.completed) completed++;
                });
            });

            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            const circumference = 100.48;
            const offset = circumference - (percentage / 100) * circumference;

            const progressRing = document.getElementById(progressId);
            const circle = progressRing.querySelector('.progress-circle-fill');
            const text = progressRing.querySelector('.progress-text');

            circle.style.strokeDashoffset = offset;
            text.textContent = percentage + '%';
        }

        // Toggle theme
        function toggleTheme() {
            settings.darkMode = !settings.darkMode;
            applyTheme();
            localStorage.setItem('settings', JSON.stringify(settings));
        }

        function applyTheme() {
            if (settings.darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('darkModeToggle').classList.add('active');
            } else {
                document.documentElement.removeAttribute('data-theme');
                document.getElementById('darkModeToggle').classList.remove('active');
            }
        }

        // Toggle show completed
        function toggleShowCompleted() {
            settings.showCompleted = !settings.showCompleted;
            const toggle = document.getElementById('showCompletedToggle');
            if (settings.showCompleted) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
            localStorage.setItem('settings', JSON.stringify(settings));
            renderTasks();
        }

        // Toggle stats panel
        function toggleStats() {
            const panel = document.getElementById('statsPanel');
            const overlay = document.getElementById('overlay');
            panel.classList.toggle('open');
            overlay.classList.toggle('active');
            updateStats();
        }

        // Toggle settings panel
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            const overlay = document.getElementById('overlay');
            panel.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        // Close panels when clicking overlay
        document.getElementById('overlay').addEventListener('click', function() {
            document.getElementById('statsPanel').classList.remove('open');
            document.getElementById('settingsPanel').classList.remove('open');
            this.classList.remove('active');
        });

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                localStorage.clear();
                taskData = initialData;
                settings = { darkMode: false, showCompleted: true };
                init();
            }
        }

        // Save data to localStorage and Firestore
        function saveData() {
            // Always save to localStorage for offline access
            localStorage.setItem('taskData', JSON.stringify(taskData));
            localStorage.setItem('settings', JSON.stringify(settings));

            // Also save to Firestore if user is signed in
            if (syncEnabled && currentUser) {
                saveToFirestore();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Cmd/Ctrl + K to focus quick add
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('quickAddToday').focus();
            }
            // Escape to close panels
            if (e.key === 'Escape') {
                document.getElementById('statsPanel').classList.remove('open');
                document.getElementById('settingsPanel').classList.remove('open');
                document.getElementById('overlay').classList.remove('active');
            }
        });

        // Initialize on load
        init();
    </script>
</body>
</html>
